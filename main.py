import json
import urllib.request
from fastai.vision import *

def handler(request):
    defaults.device = torch.device('cpu')
    // Here we download the model from the URL given in the model GET parameter and store it into /tmp folder
    model = request.args['malware']
    urllib.request.urlretrieve(model, '/tmp/malware.pkl')
    path = Path('/tmp')
    learner = load_learner(path, 'malware.pkl')

    // Here we download the image from the URL given in the image GET parameter and store it into /tmp folder
    image = request.args['image']
    urllib.request.urlretrieve(image, '/tmp/image.jpg')

    // Load up the image and try to classify it
    img = open_image('/tmp/image.jpg')
    pred_class,pred_idx,outputs = learner.predict(img)

    // Sort the classification classes from highest score to lowest, then return the response as JSON
    return json.dumps({
        "predictions": sorted(
            zip(learner.data.classes, map(float, outputs)),
            key=lambda p: p[1],
            reverse=True
        )
    })
